name: Build and Release NKAS (Build Repo)

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name (e.g. v1.0.0)'
        required: true
        default: 'v0.0.0-test'
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-release:
    runs-on: windows-latest
    
    steps:
    # 1. 检出代码
    - name: Checkout Build Repository (Current)
      uses: actions/checkout@v4
      with:
        path: NIKKEAutoScriptBuild

    - name: Checkout Main Repository (Source)
      uses: actions/checkout@v4
      with:
        repository: megumiss/NIKKEAutoScript
        path: NIKKEAutoScript
        fetch-depth: 0

    # 2. 确定 Tag
    - name: Set Tag Name
      id: tag_info
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $tagName = "${{ github.ref_name }}"
        } else {
          $tagName = "${{ inputs.tag_name }}"
        }
        echo "TAG_NAME=$tagName" >> $env:GITHUB_ENV
        Write-Host "Current Build Tag: $tagName"

    # 3. 构建 Webapp
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
        cache-dependency-path: NIKKEAutoScript/webapp/yarn.lock

    - name: Build Webapp
      working-directory: NIKKEAutoScript/webapp
      run: |
        yarn install --frozen-lockfile
        yarn run compile
        if (Test-Path "dist\win-unpacked") {
            Move-Item -Path "dist\win-unpacked" -Destination "..\app" -Force
        } else {
            exit 1
        }

    # 4. 清理与组装基础环境
    - name: Clean Unnecessary Files
      working-directory: NIKKEAutoScript
      run: |
        $keep = @("zh-CN.pak", "zh-TW.pak", "ja.pak", "en-US.pak", "en-GB.pak")
        if (Test-Path "app\locales") {
            Get-ChildItem "app\locales\*.pak" | Where-Object { $_.Name -notin $keep } | Remove-Item -Force
        }
        $filesToDelete = @("app\vulkan-1.dll", "app\vk_swiftshader_icd.json", "app\vk_swiftshader.dll", "app\LICENSES.chromium.html", "app\LICENSE.electron.txt")
        foreach ($file in $filesToDelete) { if (Test-Path $file) { Remove-Item $file -Force } }

    - name: Remove Webapp Artifacts
      working-directory: NIKKEAutoScript/webapp
      run: |
        Remove-Item node_modules -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item output -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item dist -Recurse -Force -ErrorAction SilentlyContinue

    - name: Copy Toolkit
      run: Copy-Item -Path "NIKKEAutoScriptBuild\toolkit" -Destination "NIKKEAutoScript\toolkit" -Recurse -Force

    - name: Copy nkas.exe
      run: Copy-Item -Path "NIKKEAutoScript\deploy\build\nkas.exe" -Destination "NIKKEAutoScript\nkas.exe" -Force

    - name: Install Python Dependencies
      working-directory: NIKKEAutoScript
      run: |
        & "toolkit\python.exe" -m pip install -r deploy\requirements.txt -i https://pypi.org/simple

    - name: Setup Default Config
      working-directory: NIKKEAutoScript/config
      run: if (Test-Path "deploy.template.yaml") { Copy-Item "deploy.template.yaml" -Destination "deploy.yaml" -Force }

    # ==========================
    # 5. 打包阶段 1: Standard
    # ==========================

    # 5.1 删除 .git
    - name: Remove .git (Pre-Standard)
      run: Remove-Item "NIKKEAutoScript\.git" -Recurse -Force -ErrorAction SilentlyContinue

    # 5.2 打包 Standard
    - name: Pack Standard Version (7z)
      run: |
        $fileName = "NKAS_${{ env.TAG_NAME }}.7z"
        # ⚠️ mx=5 (Normal) 兼容性更好，避免 mx=9 自动启用 BCJ2 过滤器导致部分解压软件报错
        7z a -t7z -mx=5 $fileName NIKKEAutoScript
        echo "ASSET_STD=$fileName" >> $env:GITHUB_ENV

    # ==========================
    # 6. 执行 Updater 逻辑
    # ==========================
    
    # 6.1 执行 Python 脚本
    - name: Run Installer Script
      working-directory: NIKKEAutoScript
      env: 
        PYTHONUTF8: 1
        PYTHONIOENCODING: utf-8
      run: |
        Write-Host "Running deploy/installer.py directly to mimic updater.bat..."
        # ⚠️ 直接调用 Python 等待执行结束，而不是用 start 异步启动
        & "toolkit\python.exe" deploy\installer.py
        
        # 脚本执行可能会重新生成 .git 目录(因为 git.py 会 init)，这是预期的

    # 6.2 切换 Config
    - name: Switch Config to CN
      working-directory: NIKKEAutoScript
      run: |
        if (Test-Path "config\deploy.template-cn.yaml") {
            Copy-Item "config\deploy.template-cn.yaml" -Destination "config\deploy.yaml" -Force
            Write-Host "Switched deploy.yaml to CN template."
        }

    # ==========================
    # 7. 打包阶段 2: Full CN
    # ==========================

    # 7.1 再次删除 .git
    - name: Remove .git (Pre-CN)
      run: Remove-Item "NIKKEAutoScript\.git" -Recurse -Force -ErrorAction SilentlyContinue

    # 7.2 打包 Full CN (使用 mx=5)
    - name: Pack Full CN Version (7z)
      run: |
        $fileName = "NKAS_${{ env.TAG_NAME }}_full-cn.7z"
        7z a -t7z -mx=5 $fileName NIKKEAutoScript
        echo "ASSET_CN=$fileName" >> $env:GITHUB_ENV

    # 8. 发布
    - name: Create Release and Upload
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: NKAS ${{ env.TAG_NAME }}
        draft: true
        generate_release_notes: true
        files: |
          ${{ env.ASSET_STD }}
          ${{ env.ASSET_CN }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}