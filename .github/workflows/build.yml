name: Build and Release NKAS (Build Repo)

on:
  # 手动触发 (保留此项是为了方便你在不打 Tag 的情况下也能测试构建)
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name (e.g. v1.0.0)'
        required: true
        default: 'v0.0.0-test'
  
  # 只有推送 v 开头的 tag 时才会触发
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-release:
    runs-on: windows-latest
    
    steps:
    # ==========================
    # 1. 检出代码
    # ==========================
    
    # 1.1 检出当前仓库 (NIKKEAutoScriptBuild)
    - name: Checkout Build Repository (Current)
      uses: actions/checkout@v4
      with:
        path: NIKKEAutoScriptBuild

    # 1.2 检出主代码仓库 (NIKKEAutoScript)
    - name: Checkout Main Repository (Source)
      uses: actions/checkout@v4
      with:
        repository: megumiss/NIKKEAutoScript
        path: NIKKEAutoScript
        fetch-depth: 0

    # ==========================
    # 2. 确定 Tag 名称
    # ==========================
    - name: Set Tag Name
      id: tag_info
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          # 如果是 Push Tag 触发，直接使用 Tag 名
          $tagName = "${{ github.ref_name }}"
        } else {
          # 如果是 手动 触发，使用输入的 Tag 名
          $tagName = "${{ inputs.tag_name }}"
        }
        echo "TAG_NAME=$tagName" >> $env:GITHUB_ENV
        Write-Host "Current Build Tag: $tagName"

    # ==========================
    # 3. 环境准备与 Webapp 构建
    # ==========================
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
        cache-dependency-path: NIKKEAutoScript/webapp/yarn.lock

    - name: Build Webapp
      working-directory: NIKKEAutoScript/webapp
      run: |
        yarn install --frozen-lockfile
        yarn run compile
        if (Test-Path "dist\win-unpacked") {
            Move-Item -Path "dist\win-unpacked" -Destination "..\app" -Force
        } else {
            exit 1
        }

    # ==========================
    # 4. 清理与组装
    # ==========================
    - name: Clean Unnecessary Files
      working-directory: NIKKEAutoScript
      run: |
        $keep = @("zh-CN.pak", "zh-TW.pak", "ja.pak", "en-US.pak", "en-GB.pak")
        if (Test-Path "app\locales") {
            Get-ChildItem "app\locales\*.pak" | Where-Object { $_.Name -notin $keep } | Remove-Item -Force
        }
        $filesToDelete = @("app\vulkan-1.dll", "app\vk_swiftshader_icd.json", "app\vk_swiftshader.dll", "app\LICENSES.chromium.html", "app\LICENSE.electron.txt")
        foreach ($file in $filesToDelete) { if (Test-Path $file) { Remove-Item $file -Force } }

    - name: Remove Webapp Artifacts
      working-directory: NIKKEAutoScript/webapp
      run: |
        Remove-Item node_modules -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item output -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item dist -Recurse -Force -ErrorAction SilentlyContinue

    - name: Copy Toolkit
      run: Copy-Item -Path "NIKKEAutoScriptBuild\toolkit" -Destination "NIKKEAutoScript\toolkit" -Recurse -Force

    - name: Copy nkas.exe
      run: Copy-Item -Path "NIKKEAutoScript\deploy\build\nkas.exe" -Destination "NIKKEAutoScript\nkas.exe" -Force

    - name: Install Python Dependencies
      working-directory: NIKKEAutoScript
      run: |
        & "toolkit\python.exe" -m pip install -r deploy\requirements.txt -i https://pypi.org/simple

    - name: Setup Default Config
      working-directory: NIKKEAutoScript/config
      run: if (Test-Path "deploy.template.yaml") { Copy-Item "deploy.template.yaml" -Destination "deploy.yaml" -Force }

    # ==========================
    # 5. 打包发布逻辑
    # ==========================
    
    # 打包 Standard 版
    - name: Pack Standard Version (7z)
      run: |
        $fileName = "NKAS_${{ env.TAG_NAME }}.7z"
        7z a -t7z -mx=9 $fileName NIKKEAutoScript
        echo "ASSET_STD=$fileName" >> $env:GITHUB_ENV

    # 执行 Updater 并切换 Config
    - name: Run Updater and Switch Config
      working-directory: NIKKEAutoScript
      run: |
        if (Test-Path "updater.bat") {
            Write-Host "Running updater.bat..."
            cmd /c "updater.bat"
        }
        if (Test-Path "config\deploy.template-cn.yaml") {
            Copy-Item "config\deploy.template-cn.yaml" -Destination "config\deploy.yaml" -Force
        }

    # 打包 Full-CN 版
    - name: Pack Full CN Version (7z)
      run: |
        $fileName = "NKAS_${{ env.TAG_NAME }}_full-cn.7z"
        7z a -t7z -mx=9 $fileName NIKKEAutoScript
        echo "ASSET_CN=$fileName" >> $env:GITHUB_ENV

    # 创建 Release
    - name: Create Release and Upload
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: NKAS ${{ env.TAG_NAME }}
        draft: true
        files: |
          ${{ env.ASSET_STD }}
          ${{ env.ASSET_CN }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}